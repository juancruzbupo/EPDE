generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────

enum UserRole {
  CLIENT
  ADMIN
}

enum UserStatus {
  INVITED
  ACTIVE
  INACTIVE
}

enum PropertyType {
  HOUSE
  APARTMENT
  DUPLEX
  COUNTRY_HOUSE
  OTHER
}

enum PlanStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RecurrenceType {
  MONTHLY
  QUARTERLY
  BIANNUAL
  ANNUAL
  CUSTOM
  ON_DETECTION
}

enum TaskStatus {
  PENDING
  UPCOMING
  OVERDUE
  COMPLETED
}

enum BudgetStatus {
  PENDING
  QUOTED
  APPROVED
  REJECTED
  IN_PROGRESS
  COMPLETED
}

enum ServiceUrgency {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ServiceStatus {
  OPEN
  IN_REVIEW
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum NotificationType {
  TASK_REMINDER
  BUDGET_UPDATE
  SERVICE_UPDATE
  SYSTEM
}

enum TaskType {
  INSPECTION
  CLEANING
  TEST
  TREATMENT
  SEALING
  LUBRICATION
  ADJUSTMENT
  MEASUREMENT
  EVALUATION
}

enum ProfessionalRequirement {
  OWNER_CAN_DO
  PROFESSIONAL_RECOMMENDED
  PROFESSIONAL_REQUIRED
}

enum TaskResult {
  OK
  OK_WITH_OBSERVATIONS
  NEEDS_ATTENTION
  NEEDS_REPAIR
  NEEDS_URGENT_REPAIR
  NOT_APPLICABLE
}

enum ConditionFound {
  EXCELLENT
  GOOD
  FAIR
  POOR
  CRITICAL
}

enum TaskExecutor {
  OWNER
  HIRED_PROFESSIONAL
  EPDE_PROFESSIONAL
}

enum ActionTaken {
  INSPECTION_ONLY
  CLEANING
  MINOR_REPAIR
  MAJOR_REPAIR
  REPLACEMENT
  TREATMENT
  SEALING
  ADJUSTMENT
  FULL_SERVICE
  NO_ACTION
}

// ─── Models ──────────────────────────────────────────────

model User {
  id           String     @id @default(uuid())
  email        String     @unique @db.VarChar(254)
  passwordHash String?
  name         String     @db.VarChar(200)
  phone        String?    @db.VarChar(30)
  role         UserRole   @default(CLIENT)
  status       UserStatus @default(INVITED)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  deletedAt    DateTime?

  properties      Property[]
  taskLogs        TaskLog[]
  taskNotes       TaskNote[]
  budgetRequests  BudgetRequest[]
  serviceRequests ServiceRequest[]
  notifications   Notification[]

  @@index([email])
  @@index([role, deletedAt])
}

model Property {
  id           String       @id @default(uuid())
  userId       String
  createdBy    String?
  updatedBy    String?
  address      String       @db.VarChar(500)
  city         String       @db.VarChar(200)
  type         PropertyType @default(HOUSE)
  yearBuilt    Int?
  squareMeters Float?
  photoUrl     String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  deletedAt    DateTime?

  user            User              @relation(fields: [userId], references: [id])
  maintenancePlan MaintenancePlan?
  budgetRequests  BudgetRequest[]
  serviceRequests ServiceRequest[]

  @@index([userId])
  @@index([userId, deletedAt])
}

model MaintenancePlan {
  id         String     @id @default(uuid())
  propertyId String     @unique
  name       String     @db.VarChar(200)
  status     PlanStatus @default(DRAFT)
  createdBy  String?
  updatedBy  String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // Restrict: Properties use soft-delete, never hard-deleted. Restrict prevents accidental cascade.
  property Property @relation(fields: [propertyId], references: [id], onDelete: Restrict)
  tasks    Task[]
}

model Category {
  id          String    @id @default(uuid())
  name        String    @db.VarChar(100)
  description String?   @db.VarChar(500)
  icon        String?   @db.VarChar(50)
  order       Int       @default(0)
  deletedAt   DateTime?

  tasks Task[]

  // PostgreSQL unique: (name, null) = (name, null) prevents duplicate active categories.
  // Soft-deleted categories (deletedAt != null) are each treated as distinct.
  @@unique([name, deletedAt])
  @@index([deletedAt])
}

model Task {
  id                       String                  @id @default(uuid())
  maintenancePlanId        String
  categoryId               String
  name                     String                  @db.VarChar(200)
  description              String?                 @db.VarChar(2000)
  priority                 TaskPriority            @default(MEDIUM)
  recurrenceType           RecurrenceType          @default(ANNUAL)
  recurrenceMonths         Int?
  nextDueDate              DateTime?
  order                    Int                     @default(0)
  status                   TaskStatus              @default(PENDING)
  createdBy                String?
  updatedBy                String?
  taskType                 TaskType                @default(INSPECTION)
  professionalRequirement  ProfessionalRequirement @default(OWNER_CAN_DO)
  technicalDescription     String?                 @db.VarChar(1000)
  estimatedDurationMinutes Int?
  createdAt                DateTime                @default(now())
  updatedAt                DateTime                @updatedAt
  deletedAt                DateTime?

  // Cascade: Plans are 1:1 with properties; deleting a plan removes all its tasks.
  maintenancePlan MaintenancePlan @relation(fields: [maintenancePlanId], references: [id], onDelete: Cascade)
  category        Category        @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  taskLogs        TaskLog[]
  taskNotes       TaskNote[]

  @@index([maintenancePlanId])
  @@index([maintenancePlanId, status])
  @@index([nextDueDate])
  @@index([status])
  @@index([status, nextDueDate])
  @@index([status, deletedAt])
  @@index([categoryId])
  @@index([nextDueDate, status])
  @@index([maintenancePlanId, deletedAt, status])
}

model TaskLog {
  id             String         @id @default(uuid())
  taskId         String
  completedAt    DateTime       @default(now())
  completedBy    String
  result         TaskResult
  conditionFound ConditionFound
  executor       TaskExecutor
  actionTaken    ActionTaken
  cost           Decimal?       @db.Decimal(12, 2)
  notes          String?        @db.VarChar(2000)
  photoUrl       String?

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [completedBy], references: [id], onDelete: Restrict)

  @@index([taskId])
  @@index([completedBy, completedAt])
}

model TaskNote {
  id        String   @id @default(uuid())
  taskId    String
  authorId  String
  content   String   @db.VarChar(2000)
  createdAt DateTime @default(now())

  task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id], onDelete: Restrict)

  @@index([taskId])
  @@index([authorId])
}

model BudgetRequest {
  id          String       @id @default(uuid())
  propertyId  String
  requestedBy String
  title       String       @db.VarChar(200)
  description String?      @db.VarChar(2000)
  status      BudgetStatus @default(PENDING)
  createdBy   String?
  updatedBy   String?
  version     Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?

  property  Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  requester User              @relation(fields: [requestedBy], references: [id])
  lineItems BudgetLineItem[]
  response  BudgetResponse?

  @@index([propertyId])
  @@index([propertyId, deletedAt])
  @@index([requestedBy, status])
  @@index([status])
  @@index([status, createdAt])
}

model BudgetLineItem {
  id              String  @id @default(uuid())
  budgetRequestId String
  description     String  @db.VarChar(500)
  quantity        Decimal @db.Decimal(12, 4)
  unitPrice       Decimal @db.Decimal(12, 2)
  subtotal        Decimal @db.Decimal(14, 2)

  budgetRequest BudgetRequest @relation(fields: [budgetRequestId], references: [id], onDelete: Cascade)

  @@index([budgetRequestId])
}

model BudgetResponse {
  id              String    @id @default(uuid())
  budgetRequestId String    @unique
  totalAmount     Decimal   @db.Decimal(14, 2)
  estimatedDays   Int?
  notes           String?   @db.VarChar(2000)
  validUntil      DateTime?
  respondedAt     DateTime  @default(now())

  budgetRequest BudgetRequest @relation(fields: [budgetRequestId], references: [id], onDelete: Cascade)
}

model ServiceRequest {
  id          String         @id @default(uuid())
  propertyId  String
  requestedBy String
  title       String         @db.VarChar(200)
  description String         @db.VarChar(2000)
  urgency     ServiceUrgency @default(MEDIUM)
  status      ServiceStatus  @default(OPEN)
  createdBy   String?
  updatedBy   String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?

  property  Property              @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  requester User                  @relation(fields: [requestedBy], references: [id])
  photos    ServiceRequestPhoto[]

  @@index([propertyId])
  @@index([propertyId, deletedAt])
  @@index([requestedBy, status])
  @@index([status])
  @@index([status, urgency])
}

model ServiceRequestPhoto {
  id               String   @id @default(uuid())
  serviceRequestId String
  url              String
  createdAt        DateTime @default(now())

  serviceRequest ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)

  @@index([serviceRequestId])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String           @db.VarChar(200)
  message   String           @db.VarChar(2000)
  read      Boolean          @default(false)
  data      Json?
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([userId, type, createdAt])
  @@index([createdAt])
}

// ─── Template Models (Master catalog) ───────────────────

model CategoryTemplate {
  id           String         @id @default(cuid())
  name         String         @db.VarChar(100)
  icon         String?        @db.VarChar(10)
  description  String?        @db.VarChar(500)
  displayOrder Int            @default(0)
  tasks        TaskTemplate[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model TaskTemplate {
  id                       String                  @id @default(cuid())
  name                     String                  @db.VarChar(200)
  taskType                 TaskType
  professionalRequirement  ProfessionalRequirement @default(OWNER_CAN_DO)
  technicalDescription     String?                 @db.VarChar(1000)
  priority                 TaskPriority            @default(MEDIUM)
  recurrenceType           RecurrenceType
  recurrenceMonths         Int                     @default(12)
  estimatedDurationMinutes Int?
  displayOrder             Int                     @default(0)
  categoryId               String
  category                 CategoryTemplate        @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt                DateTime                @default(now())
  updatedAt                DateTime                @updatedAt

  @@index([categoryId])
}
